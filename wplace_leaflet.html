<!doctype html>
<html>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>wplace viewer minimal v15 - frame + timeline seek</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  html,body,#map{height:100%;margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  #toolbar{position:absolute; left:10px; top:50%; transform:translateY(-50%); z-index:10000; display:flex; flex-direction:column; gap:10px; pointer-events:auto;}
  .sqbtn{min-width:48px; height:48px; border-radius:10px; border:1px solid #0006; background:rgba(20,24,31,.88); color:#e7e7e7; cursor:pointer; display:grid; place-items:center; font-weight:700}
  #topbar{position:absolute; left:70px; right:10px; top:10px; z-index:10000; display:flex; gap:10px; align-items:center; pointer-events:auto; flex-wrap:wrap}
  #hudwrap{display:flex; gap:10px; align-items:center; background:rgba(20,24,31,.55); padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.08); backdrop-filter:blur(6px);}
  #time{ width:280px; height:14px; -webkit-appearance:none; appearance:none; background:transparent; }
  #time::-webkit-slider-runnable-track{ height:3px; background:#cfcfcf; border-radius:2px }
  #time::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:14px; height:14px; border-radius:50%; background:#111; border:2px solid #fff; margin-top:-6px }
  #time::-moz-range-track{ height:3px; background:#cfcfcf; border-radius:2px }
  #time::-moz-range-thumb{ width:14px; height:14px; border-radius:50%; background:#111; border:2px solid #fff }
  .pill{ background:rgba(20,24,31,.88); color:#e7e7e7; padding:4px 10px; border-radius:999px; font-weight:700 }
  .btn4k{ min-width:80px; height:38px; border-radius:9px; border:1px solid #0006; background:rgba(20,24,31,.88); color:#e7e7e7; cursor:pointer; font-weight:700 }
  .btnNav{ min-width:46px; height:38px; border-radius:9px; border:1px solid #0006; background:rgba(20,24,31,.88); color:#e7e7e7; cursor:pointer; font-weight:800 }
  .btnNav:disabled{ opacity:.45; cursor:not-allowed }
  .wplace-single{ pointer-events:none }
  #hudMini{ position:absolute; left:12px; top:12px; z-index:11000; display:none; align-items:center; gap:8px; background:rgba(20,24,31,.80); color:#e7e7e7; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.08); font-weight:700; letter-spacing:.2px; backdrop-filter:blur(6px);}
  body.minimal #hudMini{ display:flex; } body.minimal #topbar, body.minimal #toolbar, body.minimal .leaflet-control-container{ display:none !important; }
  #dbgToggle{ position:absolute; left:10px; bottom:10px; z-index:12000; width:42px; height:28px; border-radius:6px; border:1px solid #0006; background:rgba(20,24,31,.88); color:#e7e7e7; cursor:pointer; font-weight:700 }
  #debugBox{ position:absolute; left:60px; bottom:10px; z-index:12000; display:none; max-width:60ch; background:#0b0b0b; color:#0f0; padding:8px 10px; border-radius:8px; font:12px/1.35 ui-monospace,Consolas,monospace; white-space:pre-wrap; border:1px solid #1f1f1f }
  body.debug #debugBox{ display:block } body.minimal #dbgToggle, body.minimal #debugBox{ display:none !important }

  /* Selection frame (draggable) */
  #frame{ position:absolute; z-index:10500; border:2px solid #fff; border-radius:10px;
          box-shadow:0 0 0 9999px rgba(0,0,0,.25) inset, 0 0 0 1px rgba(0,0,0,.35);
          cursor:move; user-select:none; touch-action:none; }
  #frame.hidden{ display:none }
  #frame .badge{ position:absolute; left:8px; top:8px; background:rgba(20,24,31,.85); color:#e7e7e7;
                 padding:2px 8px; border-radius:8px; font:600 12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
</style>
</head>
<body>
<div id="map"></div>

<!-- movable capture frame -->
<div id="frame"><div class="badge">Drag me · F toggles · ←/→/↑/↓ to nudge</div></div>

<div id="toolbar">
  <button id="btnMecca"  class="sqbtn" title="Mecca" type="button">Mecca</button>
  <button id="btnMedina" class="sqbtn" title="Medina" type="button">Medina</button>
  <button id="btnHUD"    class="sqbtn" title="Hide/Show HUD (H)" type="button">HUD</button>
</div>

<div id="topbar">
  <div id="hudwrap">
    <button id="btnPrev" class="btnNav" title="Previous date (,)">&larr;</button>
    <input id="time" type="range" min="0" max="1" step="1" value="0" />
    <button id="btnNext" class="btnNav" title="Next date (.)">&rarr;</button>
    <span id="label" class="pill"></span>
    <span id="z" class="pill"></span>
  </div>
  <button id="save4kMecca"  class="btn4k" title="Save Mecca 4K"  type="button">4K Mecca</button>
  <button id="save4kMedina" class="btn4k" title="Save Medina 4K" type="button">4K Medina</button>
  <button id="save4kFrame"  class="btn4k" title="Save current frame 4K @ map zoom" type="button">4K (Frame)</button>
</div>

<div id="hudMini"><span id="hudMiniText">...</span></div>
<button id="dbgToggle" title="Toggle debug" type="button">DBG</button>
<div id="debugBox">boot...</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ---------- Debug + helpers ---------- */
const DBG=(()=>{const box=document.getElementById('debugBox');const log=(m)=>{const t=new Date().toLocaleTimeString();box.textContent=`[${t}] ${m}\n`+box.textContent;};window.addEventListener('error',e=>log('ERR '+(e.message||'')+' @ '+(e.filename||'')+':'+(e.lineno||0)));window.addEventListener('unhandledrejection',e=>log('REJ '+(e.reason?.message||String(e.reason))));return{log};})();
document.getElementById('dbgToggle').addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation();document.body.classList.toggle('debug');DBG.log('debug toggled');});
const $=id=>document.getElementById(id);
function bindClick(id,fn){
  const el=$(id);
  if(!el){DBG.log('missing #'+id);return;}
  el.setAttribute('type','button');
  el.onclick=null;
  el.addEventListener('click',(ev)=>{
    ev.preventDefault(); ev.stopPropagation();
    try{ fn(ev); DBG.log('click:'+id); }catch(ex){ DBG.log('handler:'+id+' '+ex.message); }
  }, {passive:false});
}

/* ---------- Map + overlay ---------- */
const map=L.map('map',{minZoom:7,maxZoom:14,zoomSnap:0.25,zoomDelta:0.25,scrollWheelZoom:true,zoomControl:true}).setView([23.5,44],7);
L.DomEvent.disableClickPropagation(document.getElementById('toolbar'));
L.DomEvent.disableClickPropagation(document.getElementById('topbar'));
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);

const OVERLAY_Z=11, TILE=256;
let SNAPS = [{label:'loading…',dir:''}];
let currentDir = '';
let currentRegion = '-';
let snapIndex = SNAPS.length-1;

/* ---------- Tile loader with hard cancellation ---------- */
class TileLoader {
  constructor(concurrency=16){
    this.concurrency = concurrency;
    this.abort = null;
    this.gen = 0;
  }
  begin(){
    if(this.abort) this.abort.abort();
    this.abort = new AbortController();
    this.gen++;
    return {signal:this.abort.signal, gen:this.gen};
  }
  async fetchBitmap(url, signal){
    try{
      const res = await fetch(url, {signal, cache:'force-cache'});
      if(!res.ok) return null;
      const blob = await res.blob();
      const bmp = await createImageBitmap(blob).catch(()=>null);
      if(bmp) return bmp;
      return await new Promise((resolve)=>{
        const img = new Image();
        img.onload=()=>resolve(img);
        img.onerror=()=>resolve(null);
        img.src = URL.createObjectURL(blob);
      });
    }catch(e){ return null; }
  }
}

/* single-canvas overlay that aborts stale work */
class SingleCanvas extends L.Layer{
  constructor(){
    super();
    this._loader = new TileLoader(18);
  }
  onAdd(m){
    this._map=m;
    this._canvas=L.DomUtil.create('canvas','wplace-single');
    this._ctx=this._canvas.getContext('2d');
    m.getPanes().overlayPane.appendChild(this._canvas);
    m.on('moveend zoomend resize',this._render,this);
    this._render();
  }
  onRemove(m){
    m.off('moveend zoomend resize',this._render,this);
    if(this._loader.abort) this._loader.abort.abort();
    this._canvas.remove();
  }
  _size(){
    const s=this._map.getSize(),dpr=Math.min(2,window.devicePixelRatio||1);
    this._canvas.width=Math.ceil(s.x*dpr); this._canvas.height=Math.ceil(s.y*dpr);
    this._canvas.style.width=s.x+'px'; this._canvas.style.height=s.y+'px';
    const c=this._ctx; c.setTransform(dpr,0,0,dpr,0,0); c.imageSmoothingEnabled=true; c.imageSmoothingQuality='high';
  }
  _computeGrid(){
    const m=this._map, b=m.getBounds();
    const pNW=m.project(b.getNorthWest(),OVERLAY_Z);
    const pSE=m.project(b.getSouthEast(),OVERLAY_Z);
    let xMin=Math.floor(pNW.x/TILE)-1, yMin=Math.floor(pNW.y/TILE)-1;
    let xMax=Math.ceil(pSE.x/TILE)+1,  yMax=Math.ceil(pSE.y/TILE)+1;
    const WORLD=(1<<OVERLAY_Z)-1;
    xMin=Math.max(0,xMin); yMin=Math.max(0,yMin); xMax=Math.min(WORLD,xMax); yMax=Math.min(WORLD,yMax);

    const cols=[],rows=[];
    for(let xi=xMin;xi<=xMax+1;xi++){
      const ll=m.unproject([xi*TILE,yMin*TILE],OVERLAY_Z);
      cols.push(Math.round(m.latLngToLayerPoint(ll).x));
    }
    for(let yi=yMin;yi<=yMax+1;yi++){
      const ll=m.unproject([xMin*TILE,yi*TILE],OVERLAY_Z);
      rows.push(Math.round(m.latLngToLayerPoint(ll).y));
    }
    const jobs=[];
    for(let x=xMin;x<=xMax;x++){
      for(let y=yMin;y<=yMax;y++){
        const i=x-xMin,j=y-yMin;
        let x1=cols[i],x2=cols[i+1],y1=rows[j],y2=rows[j+1];
        if(x===xMin)x1--; if(x===xMax)x2++; if(y===yMin)y1--; if(y===yMax)y2++;
        jobs.push({x,y,dx:x1,dy:y1,dw:(x2-x1),dh:(y2-y1)});
      }
    }
    return jobs;
  }
  _render=async ()=>{
    if(!this._map) return;
    if(!currentDir) return; // guard: do not fetch before snaps set
    this._size();
    const c=this._ctx;
    c.clearRect(0,0,this._canvas.width,this._canvas.height);

    const {signal, gen} = this._loader.begin();
    const jobs = this._computeGrid();
    const queue = jobs.slice();
    const draw = (bmp, j)=>{
      try{
        c.drawImage(bmp,0,0,bmp.width||256,bmp.height||256,j.dx,j.dy,j.dw,j.dh);
        if(bmp.close) bmp.close();
      }catch(_){}
    };
    const worker = async ()=>{
      while(queue.length && !signal.aborted){
        const j = queue.pop();
        // robust URL resolution for relative dirs and absolute hosts
        const url = new URL(`${String(currentDir).replace(/\/+$/,'')}/${j.x}/${j.y}.png`, window.location.href).href;
        const bmp = await this._loader.fetchBitmap(url, signal);
        if(signal.aborted || gen !== this._loader.gen) return;
        if(bmp) draw(bmp, j);
      }
    };
    const N = this._loader.concurrency;
    await Promise.all(Array.from({length:N},()=>worker()).map(p=>p.catch(()=>{})));
  }
}
const overlay=new SingleCanvas().addTo(map);

/* ---------- HUD + timeline ---------- */
const timeEl=$('time'), labelEl=$('label'), zEl=$('z'), hudMini=$('hudMini'), hudMiniText=$('hudMiniText');
const btnPrev=$('btnPrev'), btnNext=$('btnNext');
const topbar=$('topbar'), toolbar=$('toolbar'), leafletCtrls=document.querySelector('.leaflet-control-container');

function updateTimelineButtons(){
  if(btnPrev) btnPrev.disabled = (snapIndex<=0);
  if(btnNext) btnNext.disabled = (snapIndex>=SNAPS.length-1);
}

function setSnap(i){
  snapIndex=Math.max(0,Math.min(SNAPS.length-1,i|0));
  if(timeEl) timeEl.value=String(snapIndex);
  const snap=SNAPS[snapIndex]||{label:'',dir:''};
  if(labelEl) labelEl.textContent=snap.label||'';
  currentDir=snap.dir||'';
  overlay._render?.();
  updateHUD();
  updateTimelineButtons();
}

function seek(delta){ setSnap(snapIndex+delta); }

function updateHUD(){
  if(zEl) zEl.textContent='Zoom '+map.getZoom().toFixed(2);
  if(hudMiniText){
    const dateText=(labelEl?.textContent||'').trim()||'-';
    hudMiniText.textContent=`${dateText} · ${currentRegion} · Z ${map.getZoom().toFixed(2)}`;
  }
}
function applyHUD(){
  const minimal=document.body.classList.contains('minimal');
  if(minimal){
    if(topbar) topbar.style.display='none';
    if(toolbar) toolbar.style.display='none';
    if(leafletCtrls) leafletCtrls.style.display='none';
    if(hudMini) hudMini.style.display='flex';
  } else {
    if(topbar) topbar.style.display='';
    if(toolbar) toolbar.style.display='';
    if(leafletCtrls) leafletCtrls.style.display='';
    if(hudMini) hudMini.style.display='none';
  }
  updateHUD();
}

/* prev/next buttons */
if (btnPrev) bindClick('btnPrev', ()=> seek(-1));
if (btnNext) bindClick('btnNext', ()=> seek(1));

/* load snaps + wire timeline */
(async ()=>{
  try {
    const r = await fetch('snaps.json', { cache:'no-store' });
    if (r.ok) SNAPS = await r.json();
  } catch (_) {}

  if (!Array.isArray(SNAPS) || SNAPS.length === 0) {
    SNAPS = [{ label:'none', dir:'' }];
  }

  if (timeEl){
    timeEl.min = '0';
    timeEl.max = String(SNAPS.length-1);
    timeEl.step = '1';
    timeEl.value = String(SNAPS.length-1);
    timeEl.oninput  = ()=> setSnap(+timeEl.value);
    timeEl.onchange = ()=> setSnap(+timeEl.value);
  }

  setSnap(SNAPS.length - 1);
})();

map.on('zoom zoomend moveend', updateHUD);
applyHUD();

/* ---------- Frame (movable) ---------- */
const frameEl = $('frame');
function initFrame(){
  const box = map.getContainer().getBoundingClientRect();
  const W = Math.min( Math.floor(box.width*0.55), 900 );
  const H = Math.floor(W*9/16);
  const x = Math.round((box.width - W)/2);
  const y = Math.round((box.height- H)/2);
  setFrameRect({x,y,w:W,h:H});
}
function getFrameRect(){
  const s = window.getComputedStyle(frameEl);
  return { x: parseInt(s.left)||0, y: parseInt(s.top)||0, w: parseInt(s.width)||0, h: parseInt(s.height)||0 };
}
function setFrameRect(r){
  const box = map.getContainer().getBoundingClientRect();
  r.w = Math.max(50, Math.min(r.w, box.width));
  r.h = Math.max(50, Math.min(r.h, box.height));
  r.x = Math.max(0, Math.min(r.x, box.width - r.w));
  r.y = Math.max(0, Math.min(r.y, box.height - r.h));
  frameEl.style.left = r.x + 'px';
  frameEl.style.top  = r.y + 'px';
  frameEl.style.width  = r.w + 'px';
  frameEl.style.height = r.h + 'px';
  DBG.log(`frame ${r.x},${r.y} ${r.w}x${r.h}`);
}
function moveFrame(dx,dy){
  const r = getFrameRect();
  setFrameRect({x:r.x+dx, y:r.y+dy, w:r.w, h:r.h});
}

let drag = null;
frameEl.addEventListener('pointerdown', ev=>{
  ev.preventDefault(); frameEl.setPointerCapture(ev.pointerId);
  const r = getFrameRect();
  drag = {startX:ev.clientX, startY:ev.clientY, base:r};
});
window.addEventListener('pointermove', ev=>{
  if(!drag) return;
  const dx = ev.clientX - drag.startX;
  const dy = ev.clientY - drag.startY;
  setFrameRect({ x: drag.base.x + dx, y: drag.base.y + dy, w: drag.base.w, h: drag.base.h });
});
window.addEventListener('pointerup', ()=>{ drag=null; });

window.addEventListener('resize', ()=>{ initFrame(); });

// frame keyboard nudging + toggles
window.addEventListener('keydown', ev=>{
  const k=ev.key.toLowerCase();
  if(k==='f'){ ev.preventDefault(); frameEl.classList.toggle('hidden'); return; }
  let step = 10;
  if(ev.altKey) step = 1;
  if(ev.shiftKey) step = 50;
  if(['arrowleft','arrowright','arrowup','arrowdown'].includes(k)){
    ev.preventDefault();
    if(k==='arrowleft')  moveFrame(-step,0);
    if(k==='arrowright') moveFrame(step,0);
    if(k==='arrowup')    moveFrame(0,-step);
    if(k==='arrowdown')  moveFrame(0,step);
  }
});

/* comma/period to seek timeline */
window.addEventListener('keydown', e=>{
  if(e.key===','){ e.preventDefault(); seek(-1); }
  if(e.key==='.'){ e.preventDefault(); seek(1); }
});

initFrame();

/* ---------- Bounds helpers ---------- */
function containerRectToBounds(rect, zoom){
  const tl = L.point(rect.x, rect.y);
  const br = L.point(rect.x+rect.w, rect.y+rect.h);
  const nw = map.containerPointToLatLng(tl);
  const se = map.containerPointToLatLng(br);
  return L.latLngBounds(nw,se);
}
function boundsFromCenterAndPx(centerLL,z,pxW,pxH){
  const pc=map.project(centerLL,z);
  const pNW=L.point(pc.x-pxW/2,pc.y-pxH/2);
  const pSE=L.point(pc.x+pxW/2,pc.y+pxH/2);
  return L.latLngBounds(map.unproject(pNW,z),map.unproject(pSE,z));
}

/* ---------- Export helpers ---------- */
function loadImg(url,cors){ return new Promise((resolve)=>{ const img=new Image(); if(cors) img.crossOrigin='anonymous'; img.onload=()=>resolve(img); img.onerror=()=>resolve(null); img.src=url; }); }
function safeName(s){ return String(s||'frame').replace(/[^0-9A-Za-z_-]/g,''); }
async function drawTileGridToCanvas(ctx,bounds,canvasW,canvasH,captureZ,tileZ,provideImg){
  const nwZ=map.project(bounds.getNorthWest(),tileZ), seZ=map.project(bounds.getSouthEast(),tileZ);
  const x0=Math.floor(nwZ.x/TILE), x1=Math.floor(seZ.x/TILE), y0=Math.floor(nwZ.y/TILE), y1=Math.floor(seZ.y/TILE);
  const boundsCapNW=map.project(bounds.getNorthWest(),captureZ), boundsCapSE=map.project(bounds.getSouthEast(),captureZ);
  const capW=boundsCapSE.x-boundsCapNW.x, capH=boundsCapSE.y-boundsCapNW.y;
  for(let x=x0;x<=x1;x++){ for(let y=y0;y<=y1;y++){
    const llNW=map.unproject([x*TILE,y*TILE],tileZ), llSE=map.unproject([(x+1)*TILE,(y+1)*TILE],tileZ);
    const pNWc=map.project(llNW,captureZ), pSEc=map.project(llSE,captureZ);
    const x1c=Math.round((pNWc.x-boundsCapNW.x)*(canvasW/capW)), y1c=Math.round((pNWc.y-boundsCapNW.y)*(canvasH/capH));
    const x2c=Math.round((pSEc.x-boundsCapNW.x)*(canvasW/capW)), y2c=Math.round((pSEc.y-boundsCapNW.y)*(canvasH/capH));
    const img=await provideImg(x,y); if(img){ try{ ctx.drawImage(img,0,0,img.width,img.height,x1c,y1c,x2c-x1c,y2c-y1c); }catch(_){ } }
  }}}
function drawBadge(ctx, text, W, H){
  const pad=28, rad=18;
  ctx.save();
  ctx.font='700 56px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif';
  ctx.textBaseline='top';
  const metrics=ctx.measureText(text);
  const tw=Math.ceil(metrics.width);
  const th=64;
  const x=32, y=32, w=tw+pad*2, h=th+pad*2;
  ctx.beginPath();
  ctx.moveTo(x+rad,y);
  ctx.arcTo(x+w,y,x+w,y+h,rad);
  ctx.arcTo(x+w,y+h,x,y+h,rad);
  ctx.arcTo(x,y+h,x,y,rad);
  ctx.arcTo(x,y,x+w,y,rad);
  ctx.closePath();
  ctx.fillStyle='rgba(20,24,31,0.85)';
  ctx.fill();
  ctx.lineWidth=2;
  ctx.strokeStyle='rgba(255,255,255,0.15)';
  ctx.stroke();
  ctx.fillStyle='#e7e7e7';
  ctx.fillText(text, x+pad, y+pad);
  ctx.restore();
}
async function renderBounds(dir, bounds, width, height, captureZoom, includeOSMFirst=true, labelText=''){
  const c=document.createElement('canvas'); c.width=width; c.height=height;
  const ctx=c.getContext('2d'); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
  const zTile=Math.floor(captureZoom);
  DBG.log(`export @ z=${captureZoom.toFixed(2)} ${bounds.getNorth().toFixed(5)},${bounds.getWest().toFixed(5)} -> ${bounds.getSouth().toFixed(5)},${bounds.getEast().toFixed(5)}`);
  if(includeOSMFirst){
    await drawTileGridToCanvas(ctx,bounds,width,height,captureZoom,zTile, async (x,y)=> await loadImg(`https://tile.openstreetmap.org/${zTile}/${x}/${y}.png`,true));
  }
  await drawTileGridToCanvas(ctx,bounds,width,height,captureZoom,OVERLAY_Z, async (x,y)=>{
    const u=new URL(`${String(dir).replace(/\/+$/,'')}/${x}/${y}.png`, window.location.href).href;
    return await loadImg(u,false);
  });
  if(labelText){ drawBadge(ctx, labelText, width, height); DBG.log('badge: '+labelText); }
  return c;
}
async function safeDownload(canvas,name,triedOSM){
  try{
    await new Promise((resolve,reject)=>{
      canvas.toBlob(b=>{
        if(!b){ reject(new Error('no blob')); return; }
        const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=name; a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href),1500);
        resolve(true);
      }, 'image/png');
    });
    return true;
  }catch(e){
    DBG.log('download failed: '+e.message+(triedOSM?' - retry overlay only':''));
    return false;
  }
}

/* ---------- Presets + region exports ---------- */
const meccaCenter = L.latLng(21.422487,39.826206);
const medinaCenter= L.latLng(24.467240,39.611432);

function makeLabel(region,z){
  const dateText=(labelEl?.textContent||'').trim()||'-';
  return `${dateText} · ${region} · Z ${z.toFixed(2)}`;
}

bindClick('btnMecca', ()=>{ currentRegion='Mecca'; map.fitBounds(L.latLngBounds([21.30,39.676],[21.545,39.976]),{padding:[40,40]}); updateHUD(); });
bindClick('btnMedina',()=>{ currentRegion='Medina';map.fitBounds(L.latLngBounds([24.3497,39.3700],[24.6997,39.9790]),{padding:[40,40]}); updateHUD(); });
bindClick('btnHUD',   ()=>{ document.body.classList.toggle('minimal'); applyHUD(); DBG.log('HUD toggled'); });

window.addEventListener('keydown',(e)=>{
  const k=e.key.toLowerCase();
  if(k==='h'){e.preventDefault();document.body.classList.toggle('minimal');applyHUD();}
  if(k==='d'){e.preventDefault();document.body.classList.toggle('debug');DBG.log('debug toggled');}
});

/* ---------- Buttons for exports ---------- */
function labelDate(){ return safeName(labelEl?.textContent); }
bindClick('save4kMecca', async ()=>{
  currentRegion='Mecca'; const label=labelDate(); const z=13.5, W=3840, H=2160;
  const b=boundsFromCenterAndPx(meccaCenter,z,W,H);
  let canvas=await renderBounds(currentDir, b, W,H,z, true, makeLabel('Mecca', z));
  if(!await safeDownload(canvas, `mecca_${label}_4k.png`, true)){
    canvas=await renderBounds(currentDir, b, W,H,z, false, makeLabel('Mecca', z));
    await safeDownload(canvas, `mecca_${label}_4k.png`, false);
  }
});
bindClick('save4kMedina', async ()=>{
  currentRegion='Medina'; const label=labelDate(); const z=13, W=3840, H=2160;
  const b=boundsFromCenterAndPx(medinaCenter,z,W,H);
  let canvas=await renderBounds(currentDir, b, W,H,z, true, makeLabel('Medina', z));
  if(!await safeDownload(canvas, `medina_${label}_4k.png`, true)){
    canvas=await renderBounds(currentDir, b, W,H,z, false, makeLabel('Medina', z));
    await safeDownload(canvas, `medina_${label}_4k.png`, false);
  }
});

/* ---------- Capture from movable frame ---------- */
bindClick('save4kFrame', async ()=>{
  const rect=getFrameRect();
  const z = map.getZoom();
  const W=3840, H=2160;
  const bounds = containerRectToBounds(rect, z);
  const label = labelDate();
  const region = currentRegion==='-' ? 'Frame' : currentRegion;
  const badge = makeLabel(region, z);
  let canvas=await renderBounds(currentDir, bounds, W,H,z, true, badge);
  if(!await safeDownload(canvas, `frame_${label}_z${z.toFixed(2)}_4k.png`, true)){
    canvas=await renderBounds(currentDir, bounds, W,H,z, false, badge);
    await safeDownload(canvas, `frame_${label}_z${z.toFixed(2)}_4k.png`, false);
  }
});

DBG.log('ready');
</script>
</body>
</html>
