<!doctype html>
<html>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>wplace viewer — site build (dynamic snaps)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  html,body,#map{height:100%;margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  #toolbar{position:absolute;left:10px;top:50%;transform:translateY(-50%);z-index:30000;display:flex;flex-direction:column;gap:10px}
  #topbar{position:absolute;left:70px;right:10px;top:10px;z-index:30000;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .sqbtn,.btn4k,.btnNav{border-radius:10px;border:1px solid #0006;background:rgba(20,24,31,.88);color:#e7e7e7;cursor:pointer;font-weight:700}
  .sqbtn{min-width:48px;height:48px;display:grid;place-items:center}
  .btn4k{min-width:80px;height:38px}
  .btnNav{min-width:46px;height:38px}
  .btnNav:disabled{opacity:.45;cursor:not-allowed}
  #hudwrap{display:flex;gap:10px;align-items:center;background:rgba(20,24,31,.55);padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);backdrop-filter:blur(6px)}
  #time{width:280px;height:14px;-webkit-appearance:none;appearance:none;background:transparent}
  #time::-webkit-slider-runnable-track{height:3px;background:#cfcfcf;border-radius:2px}
  #time::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;background:#111;border:2px solid #fff;margin-top:-6px}
  #time::-moz-range-track{height:3px;background:#cfcfcf;border-radius:2px}
  #time::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:#111;border:2px solid #fff}
  .pill{background:rgba(20,24,31,.88);color:#e7e7e7;padding:4px 10px;border-radius:999px;font-weight:700}
  #hudMini{position:absolute;left:12px;top:12px;z-index:31000;display:none;align-items:center;gap:8px;background:rgba(20,24,31,.80);color:#e7e7e7;padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);font-weight:700;letter-spacing:.2px;backdrop-filter:blur(6px)}
  body.minimal #hudMini{display:flex} body.minimal #topbar,body.minimal #toolbar,body.minimal .leaflet-control-container{display:none!important}
  #dbgToggle{position:absolute;left:10px;bottom:10px;z-index:32000;width:42px;height:28px;border-radius:6px;border:1px solid #0006;background:rgba(20,24,31,.88);color:#e7e7e7;cursor:pointer;font-weight:700}
  #debugBox{position:absolute;left:60px;bottom:10px;z-index:32000;display:none;max-width:60ch;background:#0b0b0b;color:#0f0;padding:8px 10px;border-radius:8px;font:12px/1.35 ui-monospace,Consolas,monospace;white-space:pre-wrap;border:1px solid #1f1f1f}
  body.debug #debugBox{display:block} body.minimal #dbgToggle,body.minimal #debugBox{display:none!important}
  #frame{position:absolute;z-index:29000;border:2px solid #fff;border-radius:10px;box-shadow:0 0 0 9999px rgba(0,0,0,.25) inset,0 0 0 1px rgba(0,0,0,.35);cursor:move;user-select:none;touch-action:none}
  #frame.hidden{display:none}
  #frame .badge{position:absolute;left:8px;top:8px;background:rgba(20,24,31,.85);color:#e7e7e7;padding:2px 8px;border-radius:8px;font:600 12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
</style>
</head>
<body>
<div id="map"></div>

<div id="frame"><div class="badge">Drag me · F toggles · ←/→/↑/↓ to nudge</div></div>

<div id="toolbar">
  <button id="btnMecca"  class="sqbtn" title="Mecca"  type="button">Mecca</button>
  <button id="btnMedina" class="sqbtn" title="Medina" type="button">Medina</button>
  <button id="btnHUD"    class="sqbtn" title="Hide/Show HUD (H)" type="button">HUD</button>
</div>

<div id="topbar">
  <div id="hudwrap">
    <button id="btnPrev" class="btnNav" title="Previous date (,)">&larr;</button>
    <input id="time" type="range" min="0" max="1" step="1" value="0"/>
    <button id="btnNext" class="btnNav" title="Next date (.)">&rarr;</button>
    <span id="label" class="pill"></span>
    <span id="z" class="pill"></span>
  </div>
  <button id="save4kMecca"  class="btn4k" title="Save Mecca 4K"  type="button">4K Mecca</button>
  <button id="save4kMedina" class="btn4k" title="Save Medina 4K" type="button">4K Medina</button>
  <button id="save4kFrame"  class="btn4k" title="Save current frame 4K @ map zoom" type="button">4K (Frame)</button>
</div>

<div id="hudMini"><span id="hudMiniText">...</span></div>
<button id="dbgToggle" title="Toggle debug" type="button">DBG</button>
<div id="debugBox">boot…</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const DBG=(()=>{const box=document.getElementById('debugBox');const log=(m)=>{const t=new Date().toLocaleTimeString();box.textContent=`[${t}] ${m}\n`+box.textContent;};window.addEventListener('error',e=>log('ERR '+(e.message||'')+' @ '+(e.filename||'')+':'+(e.lineno||0)));window.addEventListener('unhandledrejection',e=>log('REJ '+(e.reason?.message||String(e.reason))));return{log};})();
document.getElementById('dbgToggle').addEventListener('click',()=>{document.body.classList.toggle('debug');DBG.log('debug toggled');});
const $=id=>document.getElementById(id);
function bindClick(id,fn){const el=$(id);if(!el){DBG.log('missing #'+id);return;}el.type='button';el.onclick=fn;}

const map=L.map('map',{minZoom:7,maxZoom:14,zoomSnap:0.25,zoomDelta:0.25,scrollWheelZoom:true,zoomControl:true}).setView([23.5,44],7);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);

const TILE=256, OVERLAY_Z=11;

// Start with a harmless 1px tile; swap URL after snaps load so we avoid 404 spam
const TRANSPARENT_1PX='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
let overlay=L.tileLayer(TRANSPARENT_1PX,{tileSize:256,minZoom:7,maxZoom:14,minNativeZoom:OVERLAY_Z,maxNativeZoom:OVERLAY_Z,keepBuffer:6,updateWhenZooming:true,updateWhenIdle:false,errorTileUrl:TRANSPARENT_1PX}).addTo(map);

let SNAPS=[{label:'loading…',dir:''}], currentDir='', currentRegion='—', snapIndex=0;

const timeEl=$('time'), labelEl=$('label'), zEl=$('z'), hudMini=$('hudMini'), hudMiniText=$('hudMiniText'), btnPrev=$('btnPrev'), btnNext=$('btnNext');
const topbar=$('topbar'), toolbar=$('toolbar'), leafletCtrls=document.querySelector('.leaflet-control-container');

function updateTimelineButtons(){if(btnPrev)btnPrev.disabled=(snapIndex<=0);if(btnNext)btnNext.disabled=(snapIndex>=SNAPS.length-1);}
function setSnap(i){snapIndex=Math.max(0,Math.min(SNAPS.length-1,i|0));if(timeEl)timeEl.value=String(snapIndex);const snap=SNAPS[snapIndex]||{label:'—',dir:''};if(labelEl)labelEl.textContent=snap.label||'—';currentDir=snap.dir||'';if(currentDir)overlay.setUrl(`${currentDir}/{x}/{y}.png`);updateHUD();updateTimelineButtons();}
function seek(d){setSnap(snapIndex+d);}
function updateHUD(){if(zEl)zEl.textContent='Zoom '+map.getZoom().toFixed(2);if(hudMiniText){const dateText=(labelEl?.textContent||'—').trim();hudMiniText.textContent=`${dateText} · ${currentRegion} · Z ${map.getZoom().toFixed(2)}`;}}
function applyHUD(){const minimal=document.body.classList.contains('minimal');if(minimal){if(topbar)topbar.style.display='none';if(toolbar)toolbar.style.display='none';if(leafletCtrls)leafletCtrls.style.display='none';if(hudMini)hudMini.style.display='flex';}else{if(topbar)topbar.style.display='';if(toolbar)toolbar.style.display='';if(leafletCtrls)leafletCtrls.style.display='';if(hudMini)hudMini.style.display='none';}updateHUD();}

if(timeEl){timeEl.min='0';timeEl.step='1';let t=null;const sched=v=>{clearTimeout(t);t=setTimeout(()=>setSnap(+v),40)};timeEl.addEventListener('input',e=>sched(e.target.value));timeEl.addEventListener('change',e=>setSnap(+e.target.value));}
bindClick('btnPrev',()=>seek(-1));bindClick('btnNext',()=>seek(+1));
window.addEventListener('keydown',(e)=>{const k=e.key;if(k===','){e.preventDefault();seek(-1);}if(k==='.'){e.preventDefault();seek(+1);}const kl=k.toLowerCase();if(kl==='h'){e.preventDefault();document.body.classList.toggle('minimal');applyHUD();}if(kl==='d'){e.preventDefault();document.body.classList.toggle('debug');DBG.log('debug toggled');}});

const frameEl=$('frame');
function initFrame(){const box=map.getContainer().getBoundingClientRect();const W=Math.min(Math.floor(box.width*0.55),900);const H=Math.floor(W*9/16);const x=Math.round((box.width-W)/2);const y=Math.round((box.height-H)/2);setFrameRect({x,y,w:W,h:H});}
function getFrameRect(){const s=getComputedStyle(frameEl);return{x:parseInt(s.left)||0,y:parseInt(s.top)||0,w:parseInt(s.width)||0,h:parseInt(s.height)||0};}
function setFrameRect(r){const box=map.getContainer().getBoundingClientRect();r.w=Math.max(50,Math.min(r.w,box.width));r.h=Math.max(50,Math.min(r.h,box.height));r.x=Math.max(0,Math.min(r.x,box.width-r.w));r.y=Math.max(0,Math.min(r.y,box.height-r.h));frameEl.style.left=r.x+'px';frameEl.style.top=r.y+'px';frameEl.style.width=r.w+'px';frameEl.style.height=r.h+'px';}
function moveFrame(dx,dy){const r=getFrameRect();setFrameRect({x:r.x+dx,y:r.y+dy,w:r.w,h:r.h});}
let drag=null;frameEl.addEventListener('pointerdown',ev=>{ev.preventDefault();frameEl.setPointerCapture(ev.pointerId);const r=getFrameRect();drag={startX:ev.clientX,startY:ev.clientY,base:r};});
window.addEventListener('pointermove',ev=>{if(!drag)return;const dx=ev.clientX-drag.startX,dy=ev.clientY-drag.startY;setFrameRect({x:drag.base.x+dx,y:drag.base.y+dy,w:drag.base.w,h:drag.base.h});});
window.addEventListener('pointerup',()=>{drag=null;});
window.addEventListener('resize',()=>{initFrame();});
window.addEventListener('keydown',ev=>{const k=ev.key.toLowerCase();if(k==='f'){ev.preventDefault();frameEl.classList.toggle('hidden');return;}let step=10;if(ev.altKey)step=1;if(ev.shiftKey)step=50;if(['arrowleft','arrowright','arrowup','arrowdown'].includes(k)){ev.preventDefault();if(k==='arrowleft')moveFrame(-step,0);if(k==='arrowright')moveFrame(step,0);if(k==='arrowup')moveFrame(0,-step);if(k==='arrowdown')moveFrame(0,step);}});
initFrame();

function boundsFromCenterAndPx(centerLL,z,pxW,pxH){const pc=map.project(centerLL,z);const pNW=L.point(pc.x-pxW/2,pc.y-pxH/2);const pSE=L.point(pc.x+pxW/2,pc.y+pxH/2);return L.latLngBounds(map.unproject(pNW,z),map.unproject(pSE,z));}
function containerRectToBounds(rect,zoom){const tl=L.point(rect.x,rect.y),br=L.point(rect.x+rect.w,rect.y+rect.h);const nw=map.containerPointToLatLng(tl);const se=map.containerPointToLatLng(br);return L.latLngBounds(nw,se);}
function loadImg(url,cors){return new Promise((resolve)=>{const img=new Image();if(cors)img.crossOrigin='anonymous';img.onload=()=>resolve(img);img.onerror=()=>resolve(null);img.src=url;});}
function safeName(s){return String(s||'frame').replace(/[^0-9A-Za-z_-]/g,'');}
async function drawTileGridToCanvas(ctx,bounds,canvasW,canvasH,captureZ,tileZ,provideImg){const nwZ=map.project(bounds.getNorthWest(),tileZ),seZ=map.project(bounds.getSouthEast(),tileZ);const x0=Math.floor(nwZ.x/256),x1=Math.floor(seZ.x/256),y0=Math.floor(nwZ.y/256),y1=Math.floor(seZ.y/256);const boundsCapNW=map.project(bounds.getNorthWest(),captureZ),boundsCapSE=map.project(bounds.getSouthEast(),captureZ);const capW=boundsCapSE.x-boundsCapNW.x,capH=boundsCapSE.y-boundsCapNW.y;for(let x=x0;x<=x1;x++){for(let y=y0;y<=y1;y++){const llNW=map.unproject([x*256,y*256],tileZ),llSE=map.unproject([(x+1)*256,(y+1)*256],tileZ);const pNWc=map.project(llNW,captureZ),pSEc=map.project(llSE,captureZ);const x1c=Math.round((pNWc.x-boundsCapNW.x)*(canvasW/capW)),y1c=Math.round((pNWc.y-boundsCapNW.y)*(canvasH/capH));const x2c=Math.round((pSEc.x-boundsCapNW.x)*(canvasW/capW)),y2c=Math.round((pSEc.y-boundsCapNW.y)*(canvasH/capH));const img=await provideImg(x,y);if(img){try{ctx.drawImage(img,0,0,img.width,img.height,x1c,y1c,x2c-x1c,y2c-y1c);}catch(_){}}}}}
function drawBadge(ctx,text,W,H){const pad=28,rad=18;ctx.save();ctx.font='700 56px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif';ctx.textBaseline='top';const tw=Math.ceil(ctx.measureText(text).width),th=64;const x=32,y=32,w=tw+pad*2,h=th+pad*2;ctx.beginPath();ctx.moveTo(x+rad,y);ctx.arcTo(x+w,y,x+w,y+h,rad);ctx.arcTo(x+w,y+h,x,y+h,rad);ctx.arcTo(x,y+h,x,y,rad);ctx.arcTo(x,y,x+w,y,rad);ctx.closePath();ctx.fillStyle='rgba(20,24,31,0.85)';ctx.fill();ctx.lineWidth=2;ctx.strokeStyle='rgba(255,255,255,0.15)';ctx.stroke();ctx.fillStyle='#e7e7e7';ctx.fillText(text,x+pad,y+pad);ctx.restore();}
async function renderBounds(dir,bounds,width,height,captureZoom,includeOSMFirst=true,labelText=''){const c=document.createElement('canvas');c.width=width;c.height=height;const ctx=c.getContext('2d');ctx.imageSmoothingEnabled=true;ctx.imageSmoothingQuality='high';const zTile=Math.floor(captureZoom);if(includeOSMFirst){await drawTileGridToCanvas(ctx,bounds,width,height,captureZoom,zTile,async(x,y)=>await loadImg(`https://tile.openstreetmap.org/${zTile}/${x}/${y}.png`,true));}await drawTileGridToCanvas(ctx,bounds,width,height,captureZoom,OVERLAY_Z,async(x,y)=>await loadImg(`${dir}/${x}/${y}.png`,false));if(labelText){drawBadge(ctx,labelText,width,height);}return c;}
async function safeDownload(canvas,name,triedOSM){try{await new Promise((resolve,reject)=>{canvas.toBlob(b=>{if(!b){reject(new Error('no blob'));return;}const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=name;a.click();setTimeout(()=>URL.revokeObjectURL(a.href),1500);resolve(true);},'image/png');});return true;}catch(e){DBG.log('download failed: '+e.message+(triedOSM?' - retry overlay only':''));return false;}}
function labelDate(){return safeName(labelEl?.textContent);}

const meccaCenter=L.latLng(21.422487,39.826206), medinaCenter=L.latLng(24.467240,39.611432);
function makeLabel(region,z){const dateText=(labelEl?.textContent||'—').trim();return `${dateText} · ${region} · Z ${z.toFixed(2)}`;}

bindClick('btnMecca',()=>{currentRegion='Mecca';map.fitBounds(L.latLngBounds([21.30,39.676],[21.545,39.976]),{padding:[40,40]});updateHUD();});
bindClick('btnMedina',()=>{currentRegion='Medina';map.fitBounds(L.latLngBounds([24.3497,39.3700],[24.6997,39.9790]),{padding:[40,40]});updateHUD();});
bindClick('btnHUD',()=>{document.body.classList.toggle('minimal');applyHUD();});

bindClick('save4kMecca',async()=>{currentRegion='Mecca';const label=labelDate();const z=13.5,W=3840,H=2160;const b=boundsFromCenterAndPx(meccaCenter,z,W,H);let canvas=await renderBounds(currentDir,b,W,H,z,true,makeLabel('Mecca',z));if(!await safeDownload(canvas,`mecca_${label}_4k.png`,true)){canvas=await renderBounds(currentDir,b,W,H,z,false,makeLabel('Mecca',z));await safeDownload(canvas,`mecca_${label}_4k.png`,false);}});
bindClick('save4kMedina',async()=>{currentRegion='Medina';const label=labelDate();const z=13,W=3840,H=2160;const b=boundsFromCenterAndPx(medinaCenter,z,W,H);let canvas=await renderBounds(currentDir,b,W,H,z,true,makeLabel('Medina',z));if(!await safeDownload(canvas,`medina_${label}_4k.png`,true)){canvas=await renderBounds(currentDir,b,W,H,z,false,makeLabel('Medina',z));await safeDownload(canvas,`medina_${label}_4k.png`,false);}});
bindClick('save4kFrame',async()=>{const rect=(function(){const s=getComputedStyle(frameEl);return{x:parseInt(s.left)||0,y:parseInt(s.top)||0,w:parseInt(s.width)||0,h:parseInt(s.height)||0};})();const z=map.getZoom(),W=3840,H=2160;const b=containerRectToBounds(rect,z);const label=labelDate();const region=currentRegion==='—'?'Frame':currentRegion;let canvas=await renderBounds(currentDir,b,W,H,z,true,`${label} · ${region} · Z ${z.toFixed(2)}`);if(!await safeDownload(canvas,`frame_${label}_z${z.toFixed(2)}_4k.png`,true)){canvas=await renderBounds(currentDir,b,W,H,z,false,`${label} · ${region} · Z ${z.toFixed(2)}`);await safeDownload(canvas,`frame_${label}_z${z.toFixed(2)}_4k.png`,false);}});

(async()=>{try{const r=await fetch('snaps.json',{cache:'no-store'});if(r.ok)SNAPS=await r.json();}catch(_){}if(!Array.isArray(SNAPS)||SNAPS.length===0)SNAPS=[{label:'none',dir:''}];if(timeEl){timeEl.max=String(SNAPS.length-1);timeEl.value=String(SNAPS.length-1);}setSnap(SNAPS.length-1);map.on('zoom zoomend moveend',updateHUD);applyHUD();})();
DBG.log('ready');
</script>
</body>
</html>
